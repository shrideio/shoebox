version: '3.5'

services:

  back:
    image: dockertaiga/back
    container_name: project-back
    hostname: project-back
    restart: unless-stopped
    depends_on:
      - project-db
      - project-events
    networks:
      - project-network
    volumes:
      - taiga-back-media:/taiga-media
      - taiga-back-conf:/taiga-conf
    environment:
      - RABBIT_PORT=5672
      - TAIGA_HOST=${TAIGA_HOST}
      - TAIGA_SECRET=${TAIGA_SECRET}
      - TAIGA_SCHEME=${TAIGA_SCHEME}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBIT_HOST=${RABBIT_HOST}
      - RABBIT_USER=${POSTGRES_DB}
      - RABBIT_PASSWORD=${RABBIT_PASSWORD}
      - RABBIT_VHOST=${RABBIT_VHOST}
      - STARTUP_TIMEOUT=${STARTUP_TIMEOUT}

  front:
    image: dockertaiga/front
    container_name: project-front
    hostname: project-back
    restart: unless-stopped
    networks:
      - project-network
    volumes:
      - taiga-front-conf:/taiga-conf
    environment:
      - TAIGA_HOST=${TAIGA_HOST}
      - TAIGA_SCHEME=${TAIGA_SCHEME}

  db:
    image: postgres:11-alpine
    container_name: project-db
    restart: unless-stopped
    networks:
      - project-network
    ports:
    - ${TAIGA_POSTGRES_PORT}:5432
    volumes:
      - ${STORAGE_TAIGA_DB}:/var/lib/postgresql/data
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBIT_HOST=${RABBIT_HOST}
      - RABBIT_USER=${POSTGRES_DB}
      - RABBIT_PASSWORD=${RABBIT_PASSWORD}
      - RABBIT_VHOST=${RABBIT_VHOST}
      - STARTUP_TIMEOUT=${STARTUP_TIMEOUT}

  project-messaging:
    image: dockertaiga/rabbit
    container_name: project-messaging
    hostname: project-messaging
    restart: unless-stopped
    networks:
      - project-network
    environment:
      - RABBIT_HOST=${TAIGA_RABBIT_HOST}
      - RABBIT_USER=${TAIGA_RABBIT_USER}
      - RABBIT_PASSWORD=${TAIGA_RABBIT_PASSWORD}
      - RABBIT_VHOST=project-messaging
      - STARTUP_TIMEOUT=${STARTUP_TIMEOUT}

  project-events:
    image: dockertaiga/events
    container_name: project-events
    hostname: project-events
    restart: unless-stopped
    depends_on:
      - project-messaging
    networks:
      - project-network
    environment:
      - RABBIT_HOST=${TAIGA_RABBIT_HOST}
      - RABBIT_USER=${TAIGA_RABBIT_USER}
      - RABBIT_PASSWORD=${TAIGA_RABBIT_PASSWORD}
      - RABBIT_VHOST=project-messaging
      - TAIGA_SECRET=${TAIGA_SECRET}

  project-proxy:
    image: dockertaiga/proxy
    container_name: project-proxy
    hostname: project-proxy
    restart: unless-stopped
    depends_on:
      - project-back
      - project-front
      - project-events
    networks:
      - project-network
    ports:
      - ${PROJECT_PROXY_PORT}:80
    volumes:
      - taiga-proxy-conf:/taiga-conf
    environment:
      - TAIGA_BACK_HOST=project-back
      - TAIGA_FRONT_HOST=project-front
      - EVENTS_HOST=project-events
      - ENABLE_SSL=false


networks:
  taiga-network:
    driver: bridge


volumes:
  taiga-back-conf:
    driver_opts:
      type: none
      device: ${TAIGA_BACK_CONF}
      o: bind

  taiga-back-media:
    driver_opts:
      type: none
      device: ${STORAGE_TAIGA_BACK_MEDIA}
      o: bind

  taiga-front-conf:
    driver_opts:
      type: none
      device: ${TAIGA_FRONT_CONF}
      o: bind

  taiga-posgresql-db:
    driver_opts:
      type: none
      device: ${TAIGA_POSTGRESQL_DATA}
      o: bind

  taiga-proxy-conf:
    driver_opts:
      type: none
      device: ${TAIGA_PROXY_CONF}
      o: bind