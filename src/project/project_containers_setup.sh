#!/bin/bash
set -euo pipefail

echo "Setting up Taiga..."
echo "https://taiga.io/"
echo

SHOEBOX_ROOT=$1
YOUR_DOMAIN=$2

PROJECT_SRC=$(dirname $(realpath $0))
SRC_ROOT=$(dirname "$PROJECT_SRC")

source $SRC_ROOT/ports_prefix.ini
PROJECT_PORTS_PREFIX=${3:-$PROJECT_PORTS_PREFIX}

TAIGA_ROOT=$SHOEBOX_ROOT/project-taiga
TAIGA_SECRETS=$TAIGA_ROOT/secrets.ini

TAIGA_BACKEND_CONF=$TAIGA_ROOT/backend/conf
TAIGA_BACKEND_MEDIA=$TAIGA_ROOT/backend/media
TAIGA_FRONTEND_CONF=$TAIGA_ROOT/frontend
TAIGA_POSTGRESQL_DATA=$TAIGA_ROOT/postgresql/data
TAIGA_PROXY_CONF=$TAIGA_ROOT/proxy

TAIGA_POSTGRESQL_PORT=${PROJECT_PORTS_PREFIX}32
TAIGA_PROXY_PORT=${PROJECT_PORTS_PREFIX}80

LOCALHOST="127.0.0.1"
TAIGA_POSTGRESQL_PORT_BINDING="$LOCALHOST:$TAIGA_POSTGRESQL_PORT"
TAIGA_PROXY_PORT_BINDING="$LOCALHOST:$TAIGA_PROXY_PORT"

mkdir -p $TAIGA_BACKEND_CONF
mkdir -p $TAIGA_BACKEND_MEDIA
mkdir -p $TAIGA_FRONTEND_CONF
mkdir -p $TAIGA_POSTGRESQL_DATA
mkdir -p $TAIGA_PROXY_CONF

if test ! -f "$TAIGA_SECRETS"; then
  TAIGA_SECRET=$(openssl rand 16 -hex)
  TAIGA_POSTGRESQL_USER=taiga
  TAIGA_POSTGRESQL_PASSWORD=$(openssl rand 16 -hex)
  TAIGA_RABBIT_USER=taiga
  TAIGA_RABBIT_PASSWORD=$(openssl rand 16 -hex)
  TAIGA_REDIS_PASSWORD=$(openssl rand 16 -hex)
  echo "TAIGA_SECRET=$TAIGA_SECRET" >> $TAIGA_SECRETS
  echo "TAIGA_POSTGRESQL_USER=$TAIGA_POSTGRESQL_USER" >> $TAIGA_SECRETS
  echo "TAIGA_POSTGRESQL_PASSWORD=$TAIGA_POSTGRESQL_PASSWORD" >> $TAIGA_SECRETS
  echo "TAIGA_RABBIT_USER=$TAIGA_RABBIT_USER" >> $TAIGA_SECRETS
  echo "TAIGA_RABBIT_PASSWORD=$TAIGA_RABBIT_PASSWORD" >> $TAIGA_SECRETS
  echo "TAIGA_REDIS_PASSWORD=$TAIGA_REDIS_PASSWORD" >> $TAIGA_SECRETS
fi

source $TAIGA_SECRETS

PROJECT_ENV=$PROJECT_SRC/.env
cp $PROJECT_SRC/env.tmpl $PROJECT_ENV

sed -i 's|@YOUR_DOMAIN$|'"$YOUR_DOMAIN"'|g' $PROJECT_ENV
sed -i 's|@TAIGA_BACKEND_MEDIA$|'"$TAIGA_BACKEND_MEDIA"'|g' $PROJECT_ENV
sed -i 's|@TAIGA_BACKEND_CONF$|'"$TAIGA_BACKEND_CONF"'|g' $PROJECT_ENV
sed -i 's|@TAIGA_FRONTEND_CONF$|'"$TAIGA_FRONTEND_CONF"'|g' $PROJECT_ENV
sed -i 's|@TAIGA_POSTGRESQL_DATA$|'"$TAIGA_POSTGRESQL_DATA"'|g' $PROJECT_ENV
sed -i 's|@TAIGA_PROXY_CONF$|'"$TAIGA_PROXY_CONF"'|g' $PROJECT_ENV
sed -i 's|@TAIGA_SECRET$|'"$TAIGA_SECRET"'|g' $PROJECT_ENV
sed -i 's|@TAIGA_POSTGRESQL_USER$|'"$TAIGA_POSTGRESQL_USER"'|g' $PROJECT_ENV
sed -i 's|@TAIGA_POSTGRESQL_PASSWORD$|'"$TAIGA_POSTGRESQL_PASSWORD"'|g' $PROJECT_ENV
sed -i 's|@TAIGA_POSTGRESQL_PORT_BINDING$|'"$TAIGA_POSTGRESQL_PORT_BINDING"'|g' $PROJECT_ENV
sed -i 's|@TAIGA_RABBIT_USER$|'"$TAIGA_RABBIT_USER"'|g' $PROJECT_ENV
sed -i 's|@TAIGA_RABBIT_PASSWORD$|'"$TAIGA_RABBIT_PASSWORD"'|g' $PROJECT_ENV
sed -i 's|@TAIGA_REDIS_PASSWORD$|'"$TAIGA_REDIS_PASSWORD"'|g' $PROJECT_ENV
sed -i 's|@TAIGA_PROXY_PORT_BINDING$|'"$TAIGA_PROXY_PORT_BINDING"'|g' $PROJECT_ENV

echo "Created '.env' file at '$TAIGA_ROOT'."
echo

echo "Taiga volume mounts:"
echo "TAIGA_BACKEND_CONF: $TAIGA_BACKEND_CONF"
echo "TAIGA_BACKEND_MEDIA $TAIGA_BACKEND_MEDIA"
echo "TAIGA_FRONTEND_CONF: $TAIGA_FRONTEND_CONF"
echo "TAIGA_POSTGRESQL_DATA: $TAIGA_POSTGRESQL_DATA"
echo "TAIGA_PROXY_CONF: $TAIGA_PROXY_CONF"
echo
echo "Taiga ports"
echo "TAIGA_POSTGRESQL_PORT: $TAIGA_POSTGRESQL_PORT"
echo "TAIGA_PROXY_PORT: $TAIGA_PROXY_PORT"
echo
echo "Taiga secrets:"
echo "Taiga adimistartor user: admin/123123"
echo "TAIGA_SECRET: $TAIGA_SECRET"
echo "TAIGA_POSTGRESQL_USER: $TAIGA_POSTGRESQL_USER"
echo "TAIGA_POSTGRESQL_PASSWORD: $TAIGA_POSTGRESQL_PASSWORD"
echo "TAIGA_RABBIT_USER: $TAIGA_RABBIT_USER"
echo "TAIGA_RABBIT_PASSWORD: $TAIGA_RABBIT_PASSWORD"
echo "TAIGA_REDIS_PASSWORD: $TAIGA_REDIS_PASSWORD"
echo

echo "Completed Taiga setup."
echo